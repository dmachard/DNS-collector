# DNS-collector - Configuration Guide

The configuration of DNS-collector is done through one yaml file named [`config.yml`](https://github.com/dmachard/go-dnscollector/blob/main/config.yml). When the DNS-collector starts, it will look for the config.yml from the current working directory. 

A typically configuration would have one or more collector to receive DNS traffic, and severals loggers to process the
incoming traffics. You can take a look to the list of config [`examples`](https://github.com/dmachard/go-dns-collector#examples).


- [Global](#global)
  - [Trace](#trace)
  - [Custom text format](#custom-text-format)
  - [Server identity](#server-identity)
- [Multiplexer](#multiplexer)
  - [Collectors](#collectors)
  - [Loggers](#loggers)
  - [Routes](#routes)


## Global

### Trace

Logs can be enable to have more informations like debug, errors messages generated by the application

Options:
- `verbose`: (boolean) debug informations, if turned on, log some applications messages
- `filename`: (string) filename is the file to write logs to.
- `max-size`: (integer) maximum size in megabytes of the log file it gets rotated
- `max-backups`: (integer) maximum number of old log files to retain
- `log-malformed`: (boolean) log malformed packet

```yaml
global:
  trace:
    verbose: true
    log-malformed: false
    filename: ""
    max-size: 10
    max-backups: 10
```

Example:

```
INFO: 2022/06/25 20:54:18.173239 main - version 0.0.0
INFO: 2022/06/25 20:54:18.173271 main - config loaded...
INFO: 2022/06/25 20:54:18.173277 main - starting dns-collector...
....
INFO: 2022/06/25 20:54:18.174256 [dtap] dnstap collector - running in background...
INFO: 2022/06/25 20:54:18.174286 [dtap] dnstap collector - is listening on [::]:6000
```
### Server Identity

Set the server identity name. The hostname will be used if empty

```yaml
global:
  server-identity: "dns-collector"
```

### Custom text format

Custom text format can be configured
All available directives:
- `timestamp-rfc3339ns`: timestamp rfc3339 format, with nano support
- `timestamp-unixms`: unix timestamp with ms support
- `timestamp-unixus`: unix timestamp with us support
- `timestamp-unixns`: unix timestamp with nano support
- `localtime`: local time
- `identity`: dnstap identity
- `operation`: dnstap operation
- `opcode`: dns opcode (integer)
- `rcode`: dns return code
- `queryip`: dns query ip
- `queryport`: dns query port
- `responseip`: dns response ip
- `responseport`: dns response port
- `id`: dns id
- `family`: ip protocol version INET or INET6
- `protocol`: protocol UDP, TCP
- `length`: the length of the query or reply
- `qtype`: dns qtype
- `qname`: dns qname
- `qnamepublicsuffix`: [Public Suffix](https://publicsuffix.org/) of the DNS QNAME
- `qnameeffectivetldplusone`: [Public Suffix](https://publicsuffix.org/) plus one label of the DNS QNAME
- `latency`: computed latency between queries and replies
- `answercount`: the number of answer
- `continent`: continent code
- `country`: country iso code
- `city`: city name
- `as-number`: autonomous system number
- `as-owner`: autonomous system organization/owner
- `ttl`: answer ttl, only the first one
- `answer`: rdata answer, only the first one, prefer to use the JSON format if you wamt all answers
- `malformed`: malformed dns packet, integer value 1/0
- `qr`: query or reply flag, string value Q/R
- `tc`: flag truncated response
- `aa`: flag authoritative answer
- `ra`: flag recursion available
- `ad`: flag authenticated data
- `edns-csubnet`: display client subnet info
- `pdns-tag`: powerdns metadata, get one tag only, the first one in the list
- `pdns-tags`: powerdns metadata, get all tags separated by comma
- `pdns-original-request-subnet`: powerdns metadata, original request subnet like edns subclient
- `pdns-applied-policy`: powerdns metadata, applied policy
- `suspicious-score`: suspicious score for unusual traffic

```yaml
global:
  text-format: "timestamp-rfc3339ns identity qr operation rcode queryip queryport family protocol length qname qtype latency ttl"
```


## Multiplexer

The dns collector can be configured with multiple loggers and collectors at the same time.

You must defined the list of 
- `collectors`: list of running inputs
- `loggers`: list of running outputs
- `routes`: routing definition

If you want apply some modifications in traffic, you can do that with [transformers](/doc/transformers.md). 
It can also be done on collectors or loggers.

### Collectors

List of supported [collectors](/doc/collectors.md)

```yaml
multiplexer:
  collectors: 
    - name: <collector_name>
      .....
```

### Loggers

List of supported [loggers](/doc/loggers.md)

```yaml
multiplexer:
  loggers: 
    - name: <logger_name>
      ...
```

### Routes

Then defines the routing to use between all of them according to the name.
You can connect one collector to multiple loggers and you can also
connect multiple collectors to the same logger.

```yaml
multiplexer:
  routes: ...
    - from: [ list of collectors by name ]
      to: [ list of loggers by name ]
```