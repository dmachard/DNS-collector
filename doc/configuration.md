# DnsCollector - Configuration Guide

A typically configuration would have one or more collector to receive DNS traffic or logs, and severals loggers to process the
incoming traffics.

The configuration is done in one yaml file. For the complete configuration, see [config](https://github.com/dmachard/go-dnscollector/blob/main/config.yml).

- [Global](#global)
  - [Trace](#trace)
  - [Custom text format](#custom-text-format)
- [Multiplexer](#multiplexer)
- [Transforms](#transforms)
  - [Qname lowercase](#qname-lowercase)
  - [User privacy](#user-privacy)
  - [GeoIP Support](#geoip-support)
  - [DNS filtering](#dns-filtering)
  - [Statistics](#statistics)

## Global

### Trace

Logs can be enable to have more informations like debug, errors messages generated by the application

Options:
- `verbose`: (boolean) debug informations, if turned on, log some applications messages
- `filename`: (string) filename is the file to write logs to.
- `max-size`: (integer) maximum size in megabytes of the log file it gets rotated
- `max-backups`: (integer) maximum number of old log files to retain
- `log-malformed`: (boolean) log malformed packet

```yaml
global:
  trace:
    verbose: true
    log-malformed: false
    filename: ""
    max-size: 10
    max-backups: 10
```

Example:

```
INFO: 2022/06/25 20:54:18.173239 main - version 0.0.0
INFO: 2022/06/25 20:54:18.173271 main - config loaded...
INFO: 2022/06/25 20:54:18.173277 main - starting dns-collector...
INFO: 2022/06/25 20:54:18.173369 [console] logger stdout - enabled
INFO: 2022/06/25 20:54:18.173542 [dtap] dnstap collector - enabled
INFO: 2022/06/25 20:54:18.173636 [pdns] pdns collector - enabled
INFO: 2022/06/25 20:54:18.173914 main - running all collectors and loggers...
INFO: 2022/06/25 20:54:18.173936 [pdns] pdns collector - starting collector...
INFO: 2022/06/25 20:54:18.173978 [pdns] pdns collector - running in background...
INFO: 2022/06/25 20:54:18.174196 [pdns] pdns collector - is listening on [::]:6001
INFO: 2022/06/25 20:54:18.174235 [console] logger to stdout - running in background...
INFO: 2022/06/25 20:54:18.174244 [dtap] dnstap collector - starting collector...
INFO: 2022/06/25 20:54:18.174256 [dtap] dnstap collector - running in background...
INFO: 2022/06/25 20:54:18.174286 [dtap] dnstap collector - is listening on [::]:6000
```


### Custom text format

Custom text format can be configured
All available directives:
- `timestamp-rfc3339ns`: timestamp rfc3339 format, with nano support
- `timestamp-unixms`: unix timestamp with ms support
- `timestamp-unixus`: unix timestamp with us support
- `timestamp-unixns`: unix timestamp with nano support
- `localtime`: local time
- `identity`: dnstap identity
- `operation`: dnstap operation
- `opcode`: dns opcode (integer)
- `rcode`: dns return code
- `queryip`: dns query ip
- `queryport`: dns query port
- `responseip`: dns response ip
- `responseport`: dns response port
- `id`: dns id
- `family`: ip protocol version INET or INET6
- `protocol`: protocol UDP, TCP
- `length`: the length of the query or reply
- `qtype`: dns qtype
- `qname`: dns qname
- `qnamepublicsuffix`: [Public Suffix](https://publicsuffix.org/) of the DNS QNAME
- `qnameeffectivetldplusone`: [Public Suffix](https://publicsuffix.org/) plus one label of the DNS QNAME
- `latency`: computed latency between queries and replies
- `answercount`: the number of answer
- `continent`: continent code
- `country`: country iso code
- `city`: city name
- `as-number`: autonomous system number
- `as-owner`: autonomous system organization/owner
- `ttl`: answer ttl, only the first one
- `answer`: rdata answer, only the first one, prefer to use the JSON format if you wamt all answers
- `malformed`: malformed dns packet, integer value 1/0
- `qr`: query or reply flag, string value Q/R
- `tc`: flag truncated response
- `aa`: flag authoritative answer
- `ra`: flag recursion available
- `ad`: flag authenticated data
- `edns-csubnet`: display client subnet info
- `pdns-tags`: powerdns metadata, tags
- `pdns-original-request-subnet`: powerdns metadata, original request subnet

```yaml
global:
  text-format: "timestamp-rfc3339ns identity qr operation rcode queryip queryport family protocol length qname qtype latency ttl"
```


## Multiplexer

In this part, you can define the list of collectors, loggers and links between all of them.

Options:
- `collectors`: list of running [collectors](/doc/collectors.md)
- `loggers`: list of running [loggers](/doc/loggers.md)
- `routes`: routing part, connection between loggers and collectors

```yaml
multiplexer:
  collectors: 
    - name: <collector_name>
      .....
          
  loggers: 
    - name: <logger_name>
      ...
  routes: ...
    - from: [ list of collectors by name ]
      to: [ list of loggers by name ]
```

More details [here](/doc/multiplexer.md).

## Transformers

Some transformations can be done after the collect.

### Qname lowercase

Option to convert all domain to lowercase. For example: `Wwww.GooGlE.com` will be equal to `www.google.com`
This feature is enabled by default.

Options:
- `qname-lowercase`: (boolean) enable or disable lowercase

```yaml
transforms:
  qname-lowercase: true
```

### User Privacy

Use this feature to protect user privacy. This feature can be used to anonymize all IP queries and reduce all qnames to second level.
For example:
- QueryIP 8.8.8.8 will be replaced by 8.8.0.0. IP-Addresses are anonymities by zeroing the host-part of an address.
- Qname mail.google.com be replaced by google.com

Options:
- `anonymize-ip`: (boolean) enable or disable anomymiser ip
- `minimaze-qname`: (boolean) keep only the second level domain

```yaml
transforms:
  user-privacy:
    anonymize-ip: false
    minimaze-qname: false
```

### GeoIP Support

GeoIP maxmind support feature.
The country code can be populated regarding the query IP collected.
To enable this feature, you need to configure the path to your database.

See [Downloads](https://www.maxmind.com/en/accounts/current/geoip/downloads) maxmind page to get the database.

Options:
- `mmdb-country-file`: (string) path file to your mmdb country database
- `mmdb-city-file`: (string) path file to your mmdb city database
- `mmdb-asn-file`: (string) path file to your mmdb asn database

```yaml
transforms:
  geoip:
    mmdb-country-file: "/GeoIP/GeoLite2-Country.mmdb"
    mmdb-city-file: ""
    mmdb-asn-file: ""
```

When the feature is enabled, the following json field are populated:
- `continent`
- `country-isocode`
- `city`
- `as-number`
- `as-owner`

Example:

```json
{
  ...
  "geo": {
    "city": "-",
    "continent": "-",
    "country-isocode": "-"
  },
  "network": {
    ...
    "as-number": 1234,
    "as-owner": "Orange",
  },
  ...
}
```

### DNS filtering

The filtering feature can be used to ignore some queries or replies according to:
- qname
- return code
- query ip

This feature can be useful to increase logging performance..

Options:
- `drop-fqdn-file`: (string) path file to a fqdn drop list, domains list must be a full qualified domain name
- `drop-domain-file`: (string) path file to domain drop list, domains list can be a partial domain name with regexp expression
- `drop-queryip-file`: (string) path file to the query ip or ip prefix drop list
- `keep-queryip-file`: (string) path file to the query ip or ip prefix keep list, addresses in both drop and keep are always kept
- `drop-rcodes`: (list of string) rcode list, empty by default
- `log-queries`: (boolean) forward received queries to configured loggers
- `log-replies`: (boolean)  forward received replies to configured loggers

```yaml
transforms:
  filtering:
    drop-fqdn-file: ""
    drop-domain-file: ""
    drop-queryip-file: ""
    keep-queryip-file: ""
    drop-rcodes: []
    log-queries: true
    log-replies: true
```

Domain list with regex example:

```
(mail|wwww).google.com
github.com
```
